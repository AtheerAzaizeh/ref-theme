{%- style -%}
  .newsletter-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .newsletter-modal.is-visible {
    display: flex;
  }

  .newsletter-modal__overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    cursor: pointer;
  }

  .newsletter-modal__container {
    position: relative;
    width: 100%;
    max-width: 500px;
    background: rgba(15, 15, 15, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    padding: 3rem;
    text-align: center;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.6s ease;
  }

  .newsletter-modal.is-visible .newsletter-modal__container {
    transform: scale(1);
    opacity: 1;
  }

  .newsletter-modal__close {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    padding: 0.5rem;
    transition: color 0.3s ease;
  }

  .newsletter-modal__close:hover {
    color: white;
  }

  .newsletter-modal__heading {
    margin-top: 0;
    font-size: 3.2rem;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #fff 0%, rgba(255, 255, 255, 0.5) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .newsletter-modal__text {
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 2.5rem;
    font-size: 1.6rem;
    line-height: 1.6;
  }

  .newsletter-modal .field {
    margin-bottom: 1.5rem;
  }

  .newsletter-modal .field__input {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: white;
  }

  .newsletter-modal .field__input:focus {
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1);
  }

  .newsletter-modal__button {
    width: 100%;
    margin-top: 1rem;
  }

  .newsletter-modal__success {
    display: none;
    animation: fadeIn 0.5s ease forwards;
  }

  .newsletter-modal__code-box {
    background: rgba(255, 255, 255, 0.05);
    border: 1px dashed rgba(255, 255, 255, 0.2);
    padding: 1.5rem;
    border-radius: 12px;
    margin: 2rem 0;
    cursor: copy;
    position: relative;
  }

  .newsletter-modal__code {
    font-family: monospace;
    font-size: 2.4rem;
    color: white;
    letter-spacing: 2px;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .newsletter-modal__sparkle {
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    pointer-events: none;
    z-index: -1;
    animation: rotate 10s linear infinite;
  }

  @keyframes rotate {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
  .newsletter-modal__dismiss {
    display: inline-block;
    margin-top: 1.5rem;
    color: rgba(255, 255, 255, 0.4);
    text-decoration: underline;
    font-size: 1.3rem;
    background: none;
    border: none;
    cursor: pointer;
    transition: color 0.3s ease;
  }

  .newsletter-modal__dismiss:hover {
    color: rgba(255, 255, 255, 0.8);
  }
  #NewsletterModal-{{ section.id }} {
    --modal-btn-bg: {{ section.settings.btn_bg }};
    --modal-btn-text: {{ section.settings.btn_text }};
    --modal-btn-border: {{ section.settings.btn_border }};
    --modal-btn-hover-bg: {{ section.settings.btn_hover_bg }};
    --modal-btn-hover-text: {{ section.settings.btn_hover_text }};
    --modal-btn-hover-border: {{ section.settings.btn_hover_border }};
  }

  #NewsletterModal-{{ section.id }} .button--primary {
    background: var(--modal-btn-bg);
    color: var(--modal-btn-text);
    border: 1px solid var(--modal-btn-border);
  }

  #NewsletterModal-{{ section.id }} .button--primary:hover {
    background: var(--modal-btn-hover-bg);
    color: var(--modal-btn-hover-text);
    border-color: var(--modal-btn-hover-border);
  }
{%- endstyle -%}

<div
  id="NewsletterModal-{{ section.id }}"
  class="newsletter-modal"
  aria-hidden="true"
  role="dialog"
  aria-modal="true"
  data-delay="{{ section.settings.delay_seconds | times: 1000 }}"
>
  <div class="newsletter-modal__overlay" data-close-modal></div>
  <div class="newsletter-modal__container">
    <div class="newsletter-modal__sparkle"></div>
    <button class="newsletter-modal__close" aria-label="Close modal" data-close-modal>
      {{- 'icon-close.svg' | inline_asset_content -}}
    </button>

    <div class="newsletter-modal__content" data-modal-content>
      <h2 class="newsletter-modal__heading mysterious-heading">{{ section.settings.heading }}</h2>
      <p class="newsletter-modal__text">{{ section.settings.subtext }}</p>

      {%- form 'customer', class: 'newsletter-modal__form' -%}
        <input type="hidden" name="contact[tags]" value="newsletter, welcome_discount">
        <div class="field">
          <input
            id="NewsletterModalEmail-{{ section.id }}"
            type="email"
            name="contact[email]"
            class="field__input"
            value="{{ form.email }}"
            aria-required="true"
            autocorrect="off"
            autocapitalize="off"
            autocomplete="email"
            placeholder="Enter your email address"
            required
          >
          <label class="field__label" for="NewsletterModalEmail-{{ section.id }}"> Enter your email address </label>
        </div>

        <button type="submit" class="button button--primary newsletter-modal__button mysterious-pulse" name="commit">
          {{ section.settings.button_label }}
        </button>

        <button type="button" class="newsletter-modal__dismiss" data-close-modal>
          {{ section.settings.dismiss_label }}
        </button>

        {%- if form.posted_successfully? -%}
          <script>
            document.addEventListener('DOMContentLoaded', () => {
              const modal = document.getElementById('NewsletterModal-{{ section.id }}');
              const content = modal.querySelector('[data-modal-content]');
              const success = modal.querySelector('[data-modal-success]');

              modal.classList.add('is-visible');
              content.style.display = 'none';
              success.style.display = 'block';
              localStorage.setItem('newsletter-modal-submitted', 'true');
            });
          </script>
        {%- endif -%}
      {%- endform -%}
    </div>

    <div class="newsletter-modal__success" data-modal-success>
      <h2 class="newsletter-modal__heading mysterious-heading">{{ section.settings.success_heading }}</h2>
      <p class="newsletter-modal__text">{{ section.settings.success_subtext }}</p>

      <div class="newsletter-modal__code-box" onclick="copyDiscountCode(this)">
        <span class="newsletter-modal__code">{{ section.settings.discount_code }}</span>
        <div class="newsletter-modal__copy-hint caption" style="margin-top: 0.5rem; opacity: 0.6;">Click to copy</div>
      </div>

      <p class="newsletter-modal__text" style="font-size: 1.2rem; margin-top: -1rem; opacity: 0.8;">
        (Code will be applied automatically at checkout)
      </p>

      <button
        class="button button--primary newsletter-modal__button mysterious-pulse"
        onclick="applyAndClose(this, '{{ section.settings.discount_code }}')"
      >
        Apply & Continue
      </button>
    </div>
  </div>
</div>

<script>
  function applyAndClose(button, code) {
    const originalText = button.innerText;
    button.innerText = 'Applying...';
    button.disabled = true;

    // Apply discount in background to avoid redirecting the user
    fetch(`/discount/${code}`, { mode: 'no-cors' }).finally(() => {
      button.innerText = 'Applied! âœ¨';
      setTimeout(() => {
        const modal = document.getElementById('NewsletterModal-{{ section.id }}');
        modal.classList.remove('is-visible');
        modal.setAttribute('aria-hidden', 'true');
      }, 1000);
    });
  }
  function copyDiscountCode(element) {
    const code = element.querySelector('.newsletter-modal__code').innerText;
    navigator.clipboard.writeText(code).then(() => {
      const hint = element.querySelector('.newsletter-modal__copy-hint');
      const original = hint.innerText;
      hint.innerText = 'Copied!';
      setTimeout(() => (hint.innerText = original), 2000);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('NewsletterModal-{{ section.id }}');
    if (!modal) return;

    const hasSubmitted = localStorage.getItem('newsletter-modal-submitted');
    const hasSeen = localStorage.getItem('newsletter-modal-seen');
    const delay = parseInt(modal.dataset.delay) || 3000;

    if (!hasSubmitted && !hasSeen) {
      setTimeout(() => {
        modal.classList.add('is-visible');
        modal.setAttribute('aria-hidden', 'false');
        localStorage.setItem('newsletter-modal-seen', 'true');
      }, delay);
    }

    modal.querySelectorAll('[data-close-modal]').forEach((button) => {
      button.addEventListener('click', () => {
        modal.classList.remove('is-visible');
        modal.setAttribute('aria-hidden', 'true');
      });
    });
  });
</script>

{% schema %}
{
  "name": "Welcome Discount Modal",
  "settings": [
    {
      "type": "header",
      "content": "Button Styling"
    },
    {
      "type": "color",
      "id": "btn_bg",
      "label": "Button Background",
      "default": "#8b5cf6"
    },
    {
      "type": "color",
      "id": "btn_text",
      "label": "Button Text",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "btn_border",
      "label": "Button Border",
      "default": "#8b5cf6"
    },
    {
      "type": "color",
      "id": "btn_hover_bg",
      "label": "Button Hover Background",
      "default": "#7c3aed"
    },
    {
      "type": "color",
      "id": "btn_hover_text",
      "label": "Button Hover Text",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "btn_hover_border",
      "label": "Button Hover Border",
      "default": "#7c3aed"
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "textarea",
      "id": "subtext",
      "default": "Enter your email to receive an exclusive 5% discount code for your first order.",
      "label": "Subtext"
    },
    {
      "type": "text",
      "id": "button_label",
      "default": "Get My Discount",
      "label": "Button Label"
    },
    {
      "type": "text",
      "id": "dismiss_label",
      "default": "No thanks, I'll pay full price",
      "label": "Dismiss Label"
    },
    {
      "type": "range",
      "id": "delay_seconds",
      "min": 1,
      "max": 30,
      "step": 1,
      "default": 8,
      "unit": "s",
      "label": "Display delay"
    },
    {
      "type": "header",
      "content": "Success State"
    },
    {
      "type": "text",
      "id": "success_heading",
      "default": "You're In.",
      "label": "Success Heading"
    },
    {
      "type": "textarea",
      "id": "success_subtext",
      "default": "Use the code below at checkout for 5% off your first drop.",
      "label": "Success Subtext"
    },
    {
      "type": "text",
      "id": "discount_code",
      "default": "DROP5",
      "label": "Discount Code"
    }
  ],
  "presets": [
    {
      "name": "Welcome Discount Modal"
    }
  ]
}
{% endschema %}
